name: SonarCloud Analysis

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-analyze:
    name: Build and Analyze
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
        
    - name: Install SonarScanner
      run: |
        dotnet tool install --global dotnet-sonarscanner
        echo "$env:USERPROFILE\.dotnet\tools" >> $env:GITHUB_PATH
        
    - name: Install Coverlet
      run: dotnet tool install --global coverlet.console
      
    - name: Build and test with SonarCloud
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        # Start SonarScanner
        dotnet sonarscanner begin `
          /k:"Yegres546_NetSdrClient" `
          /o:"yegres546" `
          /d:sonar.token="$env:SONAR_TOKEN" `
          /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml" `
          /d:sonar.cpd.cs.minimumTokens=40 `
          /d:sonar.cpd.cs.minimumLines=5 `
          /d:sonar.exclusions="**/bin/**,**/obj/**,**/TestResults/**,**/*.Tests.cs" `
          /d:sonar.coverage.exclusions="**Test*.cs" `
          /d:sonar.qualitygate.wait=true

        # Build the solution
        dotnet build --configuration Release
        
        # Run tests with coverage
        dotnet test --configuration Release `
          --no-build `
          --verbosity normal `
          --collect:"XPlat Code Coverage" `
          --results-directory ./TestResults `
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

        # End SonarScanner
        dotnet sonarscanner end /d:sonar.token="$env:SONAR_TOKEN"
# name: Architecture Rules Validation

#on:
#  push:
#    branches: [ "lab5" ]
#  pull_request:
 #   branches: [ "lab5" ]
#
#jobs:
 # architecture-tests:
  #  name: Architecture Rules Validation
   # runs-on: windows-latest
    #
    #steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
        
    - name: Install dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Run Architecture Tests
      run: dotnet test --configuration Release --no-build --verbosity normal --filter "Category=Architecture"
      
    - name: Run All Tests
      run: dotnet test --configuration Release --no-build --verbosity normal
